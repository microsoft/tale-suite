description: Text Games Benchmark

environment:
  image: azureml/azureml_b48beba85ea5ab1bbaa48abeeab0bb21:latest
  username: modularpolicies
  registry: modularpolicies.azurecr.io
  setup:
    - pip install -r requirements.txt
    - ~/.local/bin/llm install plugins/gcr_llama
    - cp config/extra-openai-models.yaml $$(dirname $$(~/.local/bin/llm logs path))
    - wandb login --host=https://microsoft-research.wandb.io
    - sudo apt-get update
    - sudo apt-get install -y ca-certificates curl
    - sudo install -m 0755 -d /etc/apt/keyrings
    - sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
    - sudo chmod a+r /etc/apt/keyrings/docker.asc
    - echo \
      "deb [arch=$$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
      $$(. /etc/os-release && echo "$$VERSION_CODENAME") stable" | \
      sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
    - sudo apt-get update
    - sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
    - docker run --runtime nvidia --gpus all --restart unless-stopped --name vllm -v ~/.cache/huggingface:/root/.cache/huggingface -p 8000:8000 --ipc=host vllm/vllm-openai:latest --model meta-llama/Meta-Llama-3.1-70B-Instruct --tensor-parallel-size 4 --host 0.0.0.0

code:
  # local directory of the code. this will be uploaded to the server.
  # $CONFIG_DIR is expanded to the directory of this config file
  local_dir: $CONFIG_DIR/../

# list of jobs to run
jobs:
- name: Text Games Benchmark
  sku: G1
  identity: managed
  submit_args:
    env:
      _AZUREML_SINGULARITY_JOB_UAI: /subscriptions/693ffe34-785e-44cd-8fb7-81da25f4d3bd/resourcegroups/ModularPolicies/providers/Microsoft.ManagedIdentity/userAssignedIdentities/modularpoliciesmi
  command:
  - python benchmark.py --agent agent_llm.py:LLMAgent --llm llama -vv --context 100 --admissible_commands
